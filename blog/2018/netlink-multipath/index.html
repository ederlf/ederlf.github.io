<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Parsing the RTA_MULTIPATH attribute from Rtnetlink | Lost in the twilight hall</title> <meta name="author" content="Eder Leão Moosmann"> <meta name="description" content="Eventual writings without any strong commitment "> <meta name="keywords" content="software-defined-networking, networking , academic, portfolio-website, blog"> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700%7CRoboto+Slab:100,300,400,500,700%7CMaterial+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://ederlm.de/blog/2018/netlink-multipath/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/">Lost in the twilight hall</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">Publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">Repositories</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Parsing the RTA_MULTIPATH attribute from Rtnetlink</h1> <p class="post-meta">January 25, 2018</p> <p class="post-tags"> <a href="/blog/2018"> <i class="fas fa-calendar fa-sm"></i> 2018 </a>   ·   <a href="/blog/tag/c"> <i class="fas fa-hashtag fa-sm"></i> C,</a>   <a href="/blog/tag/networking"> <i class="fas fa-hashtag fa-sm"></i> networking,</a>   <a href="/blog/tag/programming"> <i class="fas fa-hashtag fa-sm"></i> programming,</a>   <a href="/blog/tag/rtnetlink"> <i class="fas fa-hashtag fa-sm"></i> Rtnetlink,</a>   <a href="/blog/tag/rta-multipath"> <i class="fas fa-hashtag fa-sm"></i> RTA_MULTIPATH</a>     ·   <a href="/blog/category/programming"> <i class="fas fa-tag fa-sm"></i> programming</a>   </p> </header> <article class="post-content"> <p>I am developing an application that relies on the detection of changes to the Linux kernel route tables. For the job, one can use <a href="http://man7.org/linux/man-pages/man7/rtnetlink.7.html" rel="external nofollow noopener" target="_blank">Rtnetlink</a> for reading and modification of the routing tables. For example, the <em>RTM_NEWROUTE</em> message can be used to add a new route or read from the netlink socket, indicating a new route was added to the route table.</p> <p>Netlink messages are usually composed of attributes which contain the information associated to the message type. For my use case, I need to obtain nexthop of new added routes. There are two attributes where next hops can be found:</p> <ul> <li> <p>The usual attribute for the task is <em>RTA_GATEWAY</em> in a single route message. it is not hard to find <a href="https://gist.github.com/cl4u2/5204374#file-route_dump-c-L102" rel="external nofollow noopener" target="_blank">examples</a> for that case. The next hop data in that case is fairly simply too and points directly the value of the IP address of the next hop.</p> </li> <li> <p>The second case where next hop information is present is for the <em>RTA_MULTIPATH</em> attribute. Unfortunately, the information is not that straight forward and the available examples are not very simple. This post aims to be a simpler reference for anyone looking for the right way to parse <em>RTA_MULTIPATH</em>.</p> </li> </ul> <p>The example will consider <a href="https://gist.github.com/cl4u2/5204374#file-route_monitor-c-L59" rel="external nofollow noopener" target="_blank">this loop</a>. The idea is too add the case that handles <em>RTA_MULTIPATH</em>.</p> <p>The data obtained from <em>RTA_MULTIPATH</em> is an array of <a href="https://elixir.bootlin.com/linux/v4.11/source/include/uapi/linux/rtnetlink.h#L339" rel="external nofollow noopener" target="_blank">struct rtnexthop</a>. While this struct describes all necessary information about next hops, it is not necessary to retrieve the data. For the task, rtnetlink provides macros to manipulate next hop information in the same fashion as messages.</p> <p>The code below shows how the next hops can be retrieved.</p> <figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">if</span> <span class="p">(</span><span class="n">route_attribute</span><span class="o">-&gt;</span><span class="n">rta_type</span> <span class="o">==</span> <span class="n">RTA_MULTIPATH</span><span class="p">){</span>
    <span class="cm">/* Get RTA_MULTIPATH data */</span>
    <span class="k">struct</span> <span class="n">rtnexthop</span> <span class="o">*</span><span class="n">nhptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtnexthop</span><span class="o">*</span><span class="p">)</span> <span class="n">RTA_DATA</span><span class="p">(</span><span class="n">route_attribute</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">rtnhp_len</span> <span class="o">=</span> <span class="n">RTA_PAYLOAD</span><span class="p">(</span><span class="n">route_attribute</span><span class="p">);</span>
    <span class="cm">/* Is the message complete? */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rtnhp_len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">nhptr</span><span class="p">)</span> <span class="o">||</span> 
        <span class="n">nhptr</span><span class="o">-&gt;</span><span class="n">rtnh_len</span> <span class="o">&gt;</span> <span class="n">rtnhp_len</span><span class="p">){</span>
        <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="cm">/* Get the size of the attributes */</span>
    <span class="n">attrlen</span> <span class="o">=</span> <span class="n">rtnhp_len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtnexthop</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">attrlen</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* Retrieve attributes */</span>
        <span class="k">struct</span> <span class="n">rtattr</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">RTNH_DATA</span><span class="p">(</span><span class="n">nhptr</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(;</span> <span class="n">RTA_OK</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">attrlen</span><span class="p">);</span> <span class="n">attr</span> <span class="o">=</span> <span class="n">RTA_NEXT</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">attrlen</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">rta_type</span> <span class="o">==</span> <span class="n">RTA_GATEWAY</span><span class="p">)</span> <span class="p">{</span>
                <span class="cm">/* Next hops from RTA_MULTIPATH are 
                 * contained in RTA_GATEWAY attributes! 
                 */</span>
                <span class="kt">uint32_t</span> <span class="n">nh</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span> <span class="n">RTA_DATA</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
                <span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">"%x"</span><span class="p">,</span> <span class="n">nh</span><span class="p">);</span>  
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure> <p>The initial step is to get the <em>RTA_MULTIPATH</em>, similarly to other attributes using the RTA_DATA macro. A check for the correct size of the message follows, in case the message was not fully read from the socket. If the payload of the attribute is larger than its header, the data is retrieved using RTNH_DATA. What comes next is the most interesting part. Inside the next hop data are…guess what? More attributes! The next hop is then found in the same fashion as the <a href="https://gist.github.com/cl4u2/5204374#file-route_monitor-c-L95" rel="external nofollow noopener" target="_blank">gist</a>.</p> <p>I hope this small example may help anyone looking for a way to retrieve information from the <em>RTA_MULTIPATH</em> attribute.</p> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2023 Eder Leão Moosmann. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Last updated: January 01, 2023. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="/assets/js/common.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>